name: Deploy (Self-hosted + docker-compose + prod env)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted] 
    environment: prod

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify runner & Docker installation
        run: |
          echo "Runner name: $RUNNER_NAME"
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Arch: $RUNNER_ARCH"
          which docker || echo "docker not found"
          docker --version || echo "docker not available"
          docker compose version || echo "docker compose not available"

      - name: Create .env from prod secrets
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "BANXICO_TOKEN=${{ secrets.BANXICO_TOKEN }}";
          } > .env
          chmod 600 .env

      - name: Build & Up with docker-compose
        shell: bash
        run: |
          set -e
          echo "Shutting down old containers (if any)..."
          sudo docker compose down --remove-orphans
          echo "Starting containers with build..."
          sudo docker compose --env-file .env up -d --build
          echo "Containers status:"
          sudo docker compose ps
          echo "Recent logs from banxico-app:"
          sudo docker logs --tail 50 banxico-app
